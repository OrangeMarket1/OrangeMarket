<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orange.service.impl.MemberMapper">

	<select id="isMemberTel" resultType="java.lang.Integer">
		SELECT count(*) FROM member 
		WHERE user_phone = #{tel} 
	</select>
	
	<select id="isMemberNikname" resultType="java.lang.Integer">
		SELECT count(*) FROM member 
		WHERE nik_name = #{nickname} 
	</select>
	
	<select id="isMemberEmail" resultType="java.lang.Integer">
		SELECT count(*) from member
		WHERE email = #{email}
	</select>
	
	<select id="selectEmailVerif" resultType="java.lang.Integer">
		SELECT COUNT(*)
			FROM (
			    SELECT email_code
			    FROM (
			        SELECT ROWNUM rn
			             , a.*
			        FROM (
			            SELECT email_code
			            FROM email_verify
			            WHERE email = #{email}
			                  AND use = 'N'
			                  AND expired_time >= TO_CHAR(sysdate, 'YYYY-MM-DD HH24:MI')
			            ORDER BY rdate DESC
			        ) a
			    ) b
			    WHERE rn = 1
			)
			WHERE email_code = #{emailCode}
	</select>
	
	
	<insert id="insertEmailVerif" parameterType="emailVO">
		INSERT INTO EMAIL_VERIFY(
			email
			, email_code
			, use
			, rdate
			, udate
			, expired_time
		) VALUES(
			#{email}
			, #{emailCode}
			, 'N'
			, TO_CHAR(sysdate,'YYYY-MM-DD HH24:MI')
			, sysdate
			, TO_CHAR(sysdate + 2/(24*60),'YYYY-MM-DD HH24:MI')
		)
	</insert>
	
	<insert id="insertNewMember" parameterType="memberVO">
		INSERT INTO member(
			user_id
			, email
			, user_name
			, user_phone
			, nik_name
			, user_pw
			, addr
			, addr_pass
			, rdate
			, udate
		) VALUES(
			(
		        SELECT to_char(sysdate, 'yymmdd') || lpad((
		            SELECT COUNT(*)
		            FROM member
		            WHERE user_id LIKE to_char(sysdate, 'yymmdd') || '%'
		        ) + 1, 4, '0')
		        FROM dual
		    )
			, #{email}
			, #{userName}
			, #{userPhone}
			, #{nikName}
			, #{userPw}
			, #{addr}
			, #{addrPass}
			, sysdate
			, sysdate
		)
	</insert>
	
	<update id="updateUseEmailCode">
		UPDATE email_verify
			SET USE = 'Y'
			, udate = sysdate
			WHERE email_code = #{emailCode}
				AND email=#{email}
	</update>

</mapper>